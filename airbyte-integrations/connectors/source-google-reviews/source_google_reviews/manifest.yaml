version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["reviews", "*"]
  requester:
    type: HttpRequester
    url_base: "https://mybusiness.googleapis.com/v4"
    http_method: "GET"
    authenticator:
      type: OAuthAuthenticator
      token_refresh_endpoint: "https://oauth2.googleapis.com/token?grant_type=refresh_token"
      client_id: "{{ config.client_id }}"
      client_secret: "{{ config.client_secret }}"
      refresh_token: "{{ config.refresh_token }}"
    error_handler:
      response_filters:
        - http_codes: [500, 429]
          action: RETRY
      backoff_strategies:
        - type: ExponentialBackoffStrategy
  paginator:
    type: DefaultPaginator
    page_token_option:
      type: RequestOption
      inject_into: request_parameter
      field_name: pageToken
    pagination_strategy:
      type: CursorPagination
      cursor_value: "{{ response.nextPageToken }}"
      stop_condition: "{{ not response.nextPageToken }}"
  retriever:
    requester:
      $ref: "#/definitions/requester"
    paginator:
      $ref: "#/definitions/paginator"
    record_selector:
      $ref: "#/definitions/selector"
  reviews_stream:
    selector:
      extractor:
        field_path: ["reviews", "*"]
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        $ref: "#/definitions/reviews_stream/selector"
    name: "reviews"
    primary_key: [["reviewId"]]
    # schema_loader:
    #   type: InlineSchemaLoader
    #   schema:
    #     "$schema": "http://json-schema.org/draft-07/schema#"
    #     "type": "object"
    #     "properties":
    #       "reviews":
    #         "type": "array"
    #         "items":
    #           "type": "object"
    #           "properties":
    #             "name":
    #               "type": "string"
    #               "description": "The resource name. For Review it is of the form accounts/{accountId}/locations/{locationId}/reviews/{reviewId}"
    #             "reviewId":
    #               "type": "string"
    #               "description": "The encrypted unique identifier."
    #             "reviewer":
    #               "type": "object"
    #               "properties":
    #                 "profilePhotoUrl":
    #                   "type": "string"
    #                   "description": "The profile photo link of the reviewer. Only populated if isAnonymous is false."
    #                 "displayName":
    #                   "type": "string"
    #                   "description": "The name of the reviewer. Only populated with the reviewer's real name if isAnonymous is false."
    #                 "isAnonymous":
    #                   "type": "boolean"
    #                   "description": "Indicates whether the reviewer has opted to remain anonymous."
    #               "required": ["displayName"]
    #             "starRating":
    #               "type": "string"
    #               "enum":
    #                 [
    #                   "STAR_RATING_UNSPECIFIED",
    #                   "ONE",
    #                   "TWO",
    #                   "THREE",
    #                   "FOUR",
    #                   "FIVE",
    #                 ]
    #               "description": "The star rating of the review."
    #             "comment":
    #               "type": "string"
    #               "description": "The body of the review as plain text with markups."
    #             "createTime":
    #               "type": "string"
    #               "description": "The timestamp for when the review was written. A timestamp in RFC3339 UTC 'Zulu' format."
    #               "format": "date-time"
    #             "updateTime":
    #               "type": "string"
    #               "description": "The timestamp for when the review was last modified. A timestamp in RFC3339 UTC 'Zulu' format."
    #               "format": "date-time"
    #             "reviewReply":
    #               "type": "object"
    #               "properties":
    #                 "comment":
    #                   "type": "string"
    #                   "description": "The body of the reply as plain text with markups. The maximum length is 4096 bytes."
    #                 "updateTime":
    #                   "type": "string"
    #                   "description": "The timestamp for when the reply was last modified. A timestamp in RFC3339 UTC 'Zulu' format."
    #                   "format": "date-time"
    #               "required": ["comment"]
    #           "required":
    #             [
    #               "name",
    #               "reviewId",
    #               "reviewer",
    #               "starRating",
    #               "createTime",
    #               "updateTime",
    #             ]
    #       "averageRating":
    #         "type": "number"
    #         "description": "The average star rating of all reviews for this location on a scale of 1 to 5, where 5 is the highest rating."
    #       "totalReviewCount":
    #         "type": "integer"
    #         "description": "The total number of reviews for this location."
    #       "nextPageToken":
    #         "type": "string"
    #         "description": "If the number of reviews exceeded the requested page size, this field is populated with a token to fetch the next page of reviews on a subsequent call to reviews.list. If there are no more reviews, this field is not present in the response."
    #     "required": ["reviews"]
    $parameters:
      path: "/{{ config.account_id }}/{{ config.location_id }}/reviews?pageSize=50"

streams:
  - "#/definitions/reviews_stream"

check:
  type: CheckStream
  stream_names:
    - "reviews"

spec:
  type: Spec
  documentation_url: https://docs.airbyte.com/integrations/sources/google-reviews
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: Google Reviews Spec
    type: object
    required:
      - refresh_token
      - client_id
      - client_secret
      - account_id
      - location_id
    additionalProperties: true
    properties:
      refresh_token:
        type: string
        description: User's refresh token. The token is case sensitive.
        airbyte_secret: true
      client_id:
        type: string
        description: Client id
      client_secret:
        type: string
        description: Client secret
        airbyte_secret: true
      account_id:
        type: string
        description: Google My Business Account ID
      location_id:
        type: string
        description: Google My Business Location ID
